# Predefined Functions:
# ADD(PARAMS), MULTIPLY(PARAMS), INT_FLOOR(PARAM0), RETURN(PARAM0), CONTAINS(PARAM0, PARAM1), RAND01()
# Functions can also be expressed like below:
# PARAM0.CONTAINS(PARAM1)

SKILL_EXECUTION_TYPE=[ACTIVE,PASSIVE]

SKILL=[SPELL,HERO_SECONDARY_SKILL,CREATURE_SKILL]

SPELL=[
	SPELL_BLOODLUST,
	SPELL_CURE,
	SPELL_HASTE,
	SPELL_STONE_SKIN,
]

HERO_SECONDARY_SKILL=[
	SECONDARY_SKILL_SCOUTING,
	SECONDARY_SKILL_EARTH_MAGIC,
	SECONDARY_SKILL_TACTICS,
	SECONDARY_SKILL_LOGISTICS,
]

CREATURE_SKILL=[
	SKILL_ARCHANGEL_RESURRECTION,
	SKILL_ARCHANGEL_HATRED,
	SKILL_ARCHANGEL_MORALE_BOOST,
	SKILL_PHOENIX_REBIRTH,
	SKILL_MAGIC_RESISTENCE,
]


##########
# Spells #
##########

SPELL_BLOODLUST(EXECUTION_WHEN,TARGET_COUNT,R)={
	EXECUTION=ACTIVE,
	EXECUTION_WHEN=EXECUTION_WHEN,
	CHANNELLING=INSTANT,
	DURATION=PERMANENT,
	TARGET_TYPE=TARGET_TYPE,
	TARGET_COUNT=TARGET_COUNT,
	BLACKLIST_TARGET=[UNDEAD,NONLIVING,ELEMENTAL,MACHINE],
	MODIFIER={
		ON=MELEE_ATTACK,
		VALUE_FUNCTION=ADD,
		VALUE_FUNCTION_PARAMETER=[3,MELEE_ATTACK],
	},
}

SPELL_BLOODLUST=[SPELL_BLOODLUST_BASIC,SPELL_BLOODLUST_ADVANCED,SPELL_BLOODLUST_EXPERT]
SPELL_BLOODLUST_BASIC=SPELL_BLOODLUST(AFTER_USER_SELECTION,3,FRIENDLY_SINGLE,1)
SPELL_BLOODLUST_ADVANCED=SPELL_BLOODLUST(AFTER_USER_SELECTION,6,FRIENDLY_SINGLE,1)
SPELL_BLOODLUST_EXPERT=SPELL_BLOODLUST(AFTER_SKILL_SELECTION,6,FRIENDLY_ALL,0)

###################
# Creature skills #
###################

SKILL_ARCHANGEL_RESURRECTION(STACK_NUMBER)={
	EXECUTION=ACTIVE,
	EXECUTION_WHEN=AFTER_USER_SELECTION,
	CHANNELLING=INSTANT,
	DURATION=PERMANENT,
	TARGET_TYPE=FRIENDLY_SINGLE,
	TARGET_COUNT=1,
	BLACKLIST_TARGET=[UNDEAD,NONLIVING,ELEMENTAL,MACHINE],
	MODIFIER={
		ON=HP,
		VALUE_FUNCTION=MULTIPLY,
		VALUE_FUNCTION_PARAMETER=[100,STACK_NUMBER],
	},
}

SKILL_HATRED(TARGET,DAMAGE)={
	EXECUTION=PASSIVE,
	EXECUTION_WHEN=WHOLE_BATTLE,
	CHANNELLING=NO,
	DURATION=BATTLE,
	TARGET_TYPE=ENEMY_BY_TYPE,
	TARGET=TARGET,
	MODIFIER={
		ON=DAMAGE,
		VALUE_FUNCTION=ADD,
		VALUE_FUNCTION_PARAMETER=[1.5,ON],
	},
}

SKILL_HATRED=[SKILL_ARCHANGEL_HATRED,SKILL_ANGEL_HATRED,SKILL_ARCHDEMON_HATRED,SKILL_DEMON_HATRED,SKILL_BLACK_DRAGON_HATRED]

# Skill inheritance
SKILL_ARCHANGEL_HATRED=SKILL_HATRED([DEVIL,ARCHDEVIL],DAMAGE)

# Archangel Morale Boost is applied for the whole battle.
# Returns the modified/boosted morale on all friendly units.
SKILL_ARCHANGEL_MORALE_BOOST={
	EXECUTION=PASSIVE,
	EXECUTION_WHEN=WHOLE_BATTLE,
	CHANNELLING=NO,
	DURATION=BATTLE,
	TARGET_TYPE=FRIENDLY_ALL,
	EXCLUDED_TARGET=[UNDEAD,NONLIVING,ELEMENTAL,MACHINE],
	MODIFIER={
		ON=MORALE,
		VALUE_FUNCTION=ADD,
		VALUE_FUNCTION_PARAMETER=[1,ON],
	},
}

# Phoenix rebirth is triggered after a Phoenix stack enters Death state.
# Requires the stack's stack number.
# Returns the stack number which can be revived.
SKILL_PHOENIX_REBIRTH(STACK_NUMBER)={
	EXECUTION=PASSIVE,
	EXECUTION_WHEN=AFTER_DEATH,
	CHANNELLING=NO,
	DURATION=PERMANENT,
	TARGET_TYPE=SELF,
	MODIFIER={
		ON=STACK_NUMBER,
		VALUE_FUNCTION=FUNC_PHOENIX_REBIRTH,
		VALUE_FUNCTION_PARAMETER=[0.2,STACK_NUMBER],
	}
}

# Magic resistence is settled when a unit is hit by magic.
# Requires the magic's labels, and the incoming damage.
# Returns the damage after resistence is applied.
SKILL_MAGIC_RESISTENCE(HIT_BY_MAGIC_TYPE,TARGET_MAGIC,DAMAGE)={
	EXECUTION=PASSIVE_BEFORE_HIT_BY_MAGIC,
	EXECUTION_WHEN=BEFORE_HIT_BY,
	EXECUTION_WHEN_PARAMETER=MAGIC,
	EXECUTION_FUNCTION_PARAMETER=INCOMING_MAGIC_TYPE,
	CHANNELLING=NO,
	DURATION=BATTLE,
	TARGET_TYPE=SELF,
	TARGET=[TARGET_MAGIC], # DEFAULT
	MODIFIER={
		ON=DAMAGE,
		VALUE_FUNCTION=FUNC_MAGIC_RESISTENCE,
		VALUE_FUNCTION_PARAMETER=[TARGET,INPUT[0],0,DAMAGE],
	},
}

###########################
# Definition of functions #
###########################

FUNC_MAGIC_RESISTENCE(TARGET,HIT_BY_MAGIC_TYPE,RESISTENCE,DAMAGE)={
	IF(TARGET.CONTAINS(HIT_BY_MAGIC_TYPE))
	{
		RETURN(RESISTENCE*DAMAGE)
	}
	RETURN(DAMAGE)
}

FUNC_PHOENIX_REBIRTH(REBIRTH_RATIO,STACK_NUMBER)={
	RETURN(INT_FLOOR(REBIRTH_RATIO*STACK_NUMBER)+RAND01()*REBIRTH_RATIO*STACK_NUMBER)
}